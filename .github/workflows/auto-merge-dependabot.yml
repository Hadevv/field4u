name: auto-merge-dependabot

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled]
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  enable-auto-merge:
    name: enable auto-merge
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Enable auto-merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number || 
              context.payload.check_suite?.pull_requests?.[0]?.number;

            if (!prNumber) {
              core.info('No PR number found, skipping.');
              return;
            }

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            if (pr.draft) {
              core.info('PR is draft, skipping.');
              return;
            }

            if (pr.state !== 'open') {
              core.info(`PR is ${pr.state}, skipping.`);
              return;
            }

            const hasAutomergeLabel = pr.labels.some(label => label.name === 'automerge');
            if (!hasAutomergeLabel) {
              core.info('PR does not have automerge label, skipping.');
              return;
            }

            const { data: status } = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha,
            });

            if (status.state !== 'success') {
              core.info(`Checks not successful yet (status=${status.state}).`);
              return;
            }

            if (!pr.mergeable || pr.mergeable_state !== 'clean') {
              core.info(`PR not mergeable yet (state=${pr.mergeable_state}).`);
              return;
            }

            // üé® Determine commit type for better title formatting
            let type = 'deps';
            if (pr.title.toLowerCase().includes('security') || pr.title.toLowerCase().includes('vulnerability')) {
              type = 'security';
            }

            const newTitle = `üîÄ merge(${pr.head.ref}): ${type}: ${pr.title}`;
            core.info(`Updating PR title to: "${newTitle}"`);

            try {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                title: newTitle,
              });
            } catch (error) {
              core.warning(`Failed to update PR title: ${error.message}`);
            }

            // ‚úÖ Enable auto-merge
            try {
              await github.rest.pulls.enableAutoMerge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
              });
              core.info('‚úÖ Auto-merge enabled successfully.');
            } catch (error) {
              if (error.status === 403) {
                core.warning('‚ö†Ô∏è Auto-merge not available. Check branch protection and allow auto-merge settings.');
              } else if (error.status === 405) {
                core.info('‚ÑπÔ∏è Auto-merge already enabled or not available for this PR.');
              } else {
                core.error(`‚ùå Failed to enable auto-merge: ${error.message}`);
              }
            }
