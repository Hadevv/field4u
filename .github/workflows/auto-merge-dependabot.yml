name: auto-merge-dependabot

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled]
  check_suite:
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  enable-auto-merge:
    name: enable auto-merge
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: enable auto-merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request?.number || 
              context.payload.check_suite?.pull_requests?.[0]?.number;

            if (!prNumber) {
              core.info('No PR number found, skipping');
              return;
            }

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            if (pr.draft) {
              core.info('PR is draft, skipping');
              return;
            }

            if (pr.state !== 'open') {
              core.info(`PR is ${pr.state}, skipping`);
              return;
            }

            const hasAutomergeLabel = pr.labels.some(label => label.name === 'automerge');
            if (!hasAutomergeLabel) {
              core.info('PR does not have automerge label, skipping');
              return;
            }

            const { data: status } = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha,
            });

            if (status.state === 'success' && pr.mergeable && pr.mergeable_state === 'clean') {
              try {
                await github.rest.pulls.enableAutoMerge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  merge_method: 'squash',
                });
                core.info('âœ… Auto-merge enabled');
              } catch (error) {
                if (error.status === 403) {
                  core.warning('Auto-merge not available. Ensure branch protection allows auto-merge.');
                } else if (error.status === 405) {
                  core.info('Auto-merge already enabled or not available for this PR');
                } else {
                  core.error(`Failed to enable auto-merge: ${error.message}`);
                }
              }
            } else {
              core.info(`Waiting for checks: status=${status.state}, mergeable=${pr.mergeable}, state=${pr.mergeable_state}`);
            }
